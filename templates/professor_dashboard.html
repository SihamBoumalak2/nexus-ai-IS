<!-- 
professor_dashboard.html

This is the main dashboard for professors after they log in.

🔑 Key Features:
- View a list of classes the professor is teaching
- Generate and download attendance reports
- Read and respond to student absence messages (some are handled by AI)
- View summaries generated by an AI assistant
- Use Socket.IO for future live updates
- UI components: drawer reply form, filter by class/date

CSS: Linked to 'css/professor.css'
JS: Uses Chart.js and Socket.IO
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <!-- === Meta and Title === -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professor Dashboard</title>

    <!-- === Custom Styling === -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/professor.css') }}">

    <!-- === Google Fonts for Clean UI === -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- === Chart.js: For generating attendance trend graphs === -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- === Socket.io: For live updates and notifications (e.g., new messages) === -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>

    <!-- === Inline Styling for Reply Drawer === -->
    <style>
        /* Slide-out box from the right for replying to messages */
        .reply-drawer {
            position: fixed;
            top: 0;
            right: -350px;
            width: 320px;
            height: 100vh;
            background: white;
            border-left: 3px solid black;
            padding: 15px;
            box-shadow: -3px 3px 10px rgba(0, 0, 0, 0.2);
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            overflow-y: auto;
        }

        /* Button to close the drawer */
        .close-reply {
            background: red;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 5px 10px;
            width: 100%;
        }
    </style>
</head>
<body>

    <!-- === Top Navigation Bar === -->
    <header class="navbar">
        <div class="container">
            <h1>Professor Dashboard</h1>
            <nav>
                <a href="{{ url_for('home') }}">🏠 Home</a>
                <a href="{{ url_for('about') }}">ℹ️ About</a>
                <a href="{{ url_for('logout_professor') }}" class="logout-btn">🚪 Logout</a>
            </nav>
        </div>
    </header>

    <!-- === Main Dashboard Container === -->
    <div class="container">

        <!-- === List of Classes the Professor Teaches === -->
        <section class="card">
            <h2>📚 My Classes</h2>
            <ul class="class-list">
                {% for class in classes %}
                    <li>
                        <span class="class-name">{{ class.class_name }}</span>
                        <a href="{{ url_for('view_classroom', class_id=class.id) }}" class="view-btn">👀 View Class</a>
                    </li>
                {% endfor %}
            </ul>
        </section>

        <!-- === Attendance Report Generator === -->
        <section class="card">
            <h2>📊 Generate Attendance Report</h2>
            <form action="/generate-report" method="POST">
                <label for="class_id">Select a Class:</label>
                <select name="class_id" required>
                    {% for class in classes %}
                        <option value="{{ class.id }}">{{ class.class_name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary">📄 Generate Report</button>
            </form>
        </section>

        <!-- === Show Report Output (If Exists) === -->
        {% if report %}
            <section class="card">
                {{ report | safe }}
                <br>
                <a href="{{ csv_path }}" download class="btn btn-primary">📥 Download CSV</a>
            </section>

            <!-- === AI Summary Box (Only If Provided) === -->
            {% if summary %}
            <section class="card alert alert-info mt-3">
                <h4>🧠 AI Summary</h4>
                <p>{{ summary | safe }}</p>
            </section>
            {% endif %}
        {% endif %}

        <!-- === Message Center (Student Absence Requests) === -->
        <section class="card">
            <h2>📩 Student Absence Messages</h2>

            <!-- === Filter Messages by Class or Date === -->
            <div class="filters">
                <label for="classFilter"><strong>Filter by Class:</strong></label>
                <select id="classFilter" onchange="filterMessages()">
                    <option value="all">All Classes</option>
                    {% for class in classes %}
                    <option value="{{ class.class_name }}">{{ class.class_name }}</option>
                    {% endfor %}
                </select>

                <label for="dateFilter"><strong>Filter by Date:</strong></label>
                <input type="date" id="dateFilter" onchange="filterMessages()" value="{{ today }}">
            </div>

            <!-- === Table of Messages === -->
            <table id="messagesTable">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Class</th>
                        <th>Message</th>
                        <th>Received At</th>
                        <th>Status</th>
                        <th>Reply</th>
                    </tr>
                </thead>
                <tbody>
                    {% for message in messages %}
                        <tr class="message-row" data-class="{{ message.class_name }}" data-date="{{ message.timestamp.split(' ')[0] }}">
                            <td>{{ message.name }}</td>
                            <td>{{ message.class_name }}</td>
                            <td>{{ message.message }}</td>
                            <td>{{ message.timestamp }}</td>
                            <td>
                                {% if message.ai_handled %}
                                    ✅ AI Handled
                                {% else %}
                                    ❌ Requires Professor Review
                                {% endif %}
                            </td>
                            <td>
                                {% if not message.ai_handled %}
                                    <form method="POST" action="{{ url_for('reply_message') }}">
                                        <input type="hidden" name="message_id" value="{{ message.id }}">
                                        <textarea name="reply_message" placeholder="Enter your response..."></textarea>
                                        <button type="submit">📤 Send Reply</button>
                                    </form>
                                {% else %}
                                    <span>AI Responded</span>
                                {% endif %}
                            </td>
                        </tr>

                        <!-- === Optional AI Response (If Exists) === -->
                        {% if message.ai_response %}
                        <tr class="ai-response-row" data-class="{{ message.class_name }}" data-date="{{ message.timestamp.split(' ')[0] }}">
                            <td colspan="6">🤖 AI Response: <strong>{{ message.ai_response.message }}</strong> ({{ message.ai_response.timestamp }})</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </section>
    </div>

    <!-- === Slide-Out Drawer for Replying to Messages === -->
    <div id="replyDrawer" class="reply-drawer">
        <button class="close-reply" onclick="closeReplyBox()">✖ Close</button>
        <h3>💬 Reply to Absence Message</h3>
        <p><strong>Student:</strong> <span id="reply-student-name"></span></p>
        <p><strong>Class:</strong> <span id="reply-class-name"></span></p>
        <p><strong>Original Message:</strong> <span id="reply-original-message"></span></p>
        <form id="reply-form" method="POST" action="{{ url_for('reply_message') }}">
            <input type="hidden" id="reply-message-id" name="message_id">
            <label for="reply-message">Your Response:</label>
            <textarea id="reply-message" name="reply_message" required></textarea>
            <button type="submit">📤 Send</button>
        </form>
    </div>

    <!-- === JavaScript Logic for Filtering, Replying, Drawer Behavior === -->
    <script>
        var socket = io();

        // Opens the reply drawer with pre-filled data
        function openReplyBox(messageId, studentName, className, originalMessage) {
            document.getElementById("reply-message-id").value = messageId;
            document.getElementById("reply-student-name").textContent = studentName;
            document.getElementById("reply-class-name").textContent = className;
            document.getElementById("reply-original-message").textContent = originalMessage;
            document.getElementById("replyDrawer").style.right = "0px";
        }

        // Closes the drawer
        function closeReplyBox() {
            document.getElementById("replyDrawer").style.right = "-350px";
        }

        // Filter messages based on class and date selection
        function filterMessages() {
            let selectedClass = document.getElementById("classFilter").value;
            let selectedDate = document.getElementById("dateFilter").value;
            let rows = document.querySelectorAll(".message-row");

            rows.forEach(row => {
                let classMatch = (selectedClass === "all" || row.getAttribute("data-class") === selectedClass);
                let dateMatch = (!selectedDate || row.getAttribute("data-date") === selectedDate);

                if (classMatch && dateMatch) {
                    row.style.display = "";
                    let aiResponseRow = row.nextElementSibling;
                    if (aiResponseRow && aiResponseRow.classList.contains("ai-response-row")) {
                        aiResponseRow.style.display = "";
                    }
                } else {
                    row.style.display = "none";
                    let aiResponseRow = row.nextElementSibling;
                    if (aiResponseRow && aiResponseRow.classList.contains("ai-response-row")) {
                        aiResponseRow.style.display = "none";
                    }
                }
            });
        }

        // Pre-set date filter to today's date
        document.addEventListener("DOMContentLoaded", function () {
            let today = new Date().toISOString().split("T")[0];
            document.getElementById("dateFilter").value = today;
            filterMessages();
        });

        // Submit the drawer reply form (intercept before sending)
        document.addEventListener("DOMContentLoaded", function () {
            const replyForm = document.getElementById("reply-form");

            if (replyForm) {
                replyForm.addEventListener("submit", function (event) {
                    event.preventDefault();
                    closeReplyBox();
                });
            } else {
                console.error("❌ Error: reply-form not found in the DOM.");
            }
        });

        // Final POST submission via fetch to reply to a message
        document.getElementById('reply-form').addEventListener('submit', function (event) {
            event.preventDefault();

            let messageId = document.getElementById('reply-message-id').value;
            let replyMessage = document.getElementById('reply-message').value;

            fetch('{{ url_for("reply_message") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    message_id: messageId,
                    reply_message: replyMessage
                })
            })
            .then(response => {
                if (response.ok) {
                    alert('Message sent successfully');
                    closeReplyBox();
                } else {
                    alert('Something went wrong');
                }
            })
            .catch(error => console.error('Error:', error));
        });
    </script>
</body>
</html>
